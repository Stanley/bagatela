<!DOCTYPE html>
<html>
<head>
  <meta http-equiv='content-type' value='text/html;charset=utf8'>
  <meta name='generator' value='Ronn/v0.7.3 (http://github.com/rtomayko/ronn/tree/0.7.3)'>
  <title>bagatela(1) - wyszukiwarka, bagatela, połączeń w komunikacji miejskiej</title>
  <style type='text/css' media='all'>
  /* style: man */
  body#manpage {margin:0}
  .mp {max-width:100ex;padding:0 9ex 1ex 4ex}
  .mp p,.mp pre,.mp ul,.mp ol,.mp dl {margin:0 0 20px 0}
  .mp h2 {margin:10px 0 0 0}
  .mp > p,.mp > pre,.mp > ul,.mp > ol,.mp > dl {margin-left:8ex}
  .mp h3 {margin:0 0 0 4ex}
  .mp dt {margin:0;clear:left}
  .mp dt.flush {float:left;width:8ex}
  .mp dd {margin:0 0 0 9ex}
  .mp h1,.mp h2,.mp h3,.mp h4 {clear:left}
  .mp pre {margin-bottom:20px}
  .mp pre+h2,.mp pre+h3 {margin-top:22px}
  .mp h2+pre,.mp h3+pre {margin-top:5px}
  .mp img {display:block;margin:auto}
  .mp h1.man-title {display:none}
  .mp,.mp code,.mp pre,.mp tt,.mp kbd,.mp samp,.mp h3,.mp h4 {font-family:monospace;font-size:14px;line-height:1.42857142857143}
  .mp h2 {font-size:16px;line-height:1.25}
  .mp h1 {font-size:20px;line-height:2}
  .mp {text-align:justify;background:#fff}
  .mp,.mp code,.mp pre,.mp pre code,.mp tt,.mp kbd,.mp samp {color:#131211}
  .mp h1,.mp h2,.mp h3,.mp h4 {color:#030201}
  .mp u {text-decoration:underline}
  .mp code,.mp strong,.mp b {font-weight:bold;color:#131211}
  .mp em,.mp var {font-style:italic;color:#232221;text-decoration:none}
  .mp a,.mp a:link,.mp a:hover,.mp a code,.mp a pre,.mp a tt,.mp a kbd,.mp a samp {color:#0000ff}
  .mp b.man-ref {font-weight:normal;color:#434241}
  .mp pre {padding:0 4ex}
  .mp pre code {font-weight:normal;color:#434241}
  .mp h2+pre,h3+pre {padding-left:0}
  ol.man-decor,ol.man-decor li {margin:3px 0 10px 0;padding:0;float:left;width:33%;list-style-type:none;text-transform:uppercase;color:#999;letter-spacing:1px}
  ol.man-decor {width:100%}
  ol.man-decor li.tl {text-align:left}
  ol.man-decor li.tc {text-align:center;letter-spacing:4px}
  ol.man-decor li.tr {text-align:right;float:right}
  </style>
  <style type='text/css' media='all'>
  /* style: toc */
  .man-navigation {display:block !important;position:fixed;top:0;left:113ex;height:100%;width:100%;padding:48px 0 0 0;border-left:1px solid #dbdbdb;background:#eee}
  .man-navigation a,.man-navigation a:hover,.man-navigation a:link,.man-navigation a:visited {display:block;margin:0;padding:5px 2px 5px 30px;color:#999;text-decoration:none}
  .man-navigation a:hover {color:#111;text-decoration:underline}
  </style>
  <style type='text/css' media='all'>
  /* style: custom */
  pre{border: 1px solid #CACACA;border-radius: 3px;overflow: auto;padding: 10px !important}
  </style>
</head>
<!--
  The following styles are deprecated and will be removed at some point:
  div#man, div#man ol.man, div#man ol.head, div#man ol.man.

  The .man-page, .man-decor, .man-head, .man-foot, .man-title, and
  .man-navigation should be used instead.
-->
<body id='manpage'>
  <div class='mp' id='man'>

  <div class='man-navigation' style='display:none'>
    <a href="#NAME">NAME</a>
    <a href="#WST-P-DO-API">WSTĘP DO API</a>
    <a href="#ZAPYTANIA-O-DANE">ZAPYTANIA O DANE</a>
    <a href="#ZASOBY">ZASOBY</a>
    <a href="#ROZK-AD-JAZDY">ROZKŁAD JAZDY</a>
    <a href="#PRZYSTANEK">PRZYSTANEK</a>
    <a href="#WYSZUKIWARKA-PO-CZE-">WYSZUKIWARKA POŁĄCZEŃ</a>
    <a href="#REPLIKACJE">REPLIKACJE</a>
    <a href="#SCENARIUSZE-TESTUJ-CE">SCENARIUSZE TESTUJĄCE</a>
  </div>

  <ol class='man-decor man-head man head'>
    <li class='tl'>bagatela(1)</li>
    <li class='tc'></li>
    <li class='tr'>bagatela(1)</li>
  </ol>

  <h2 id="NAME">NAME</h2>
<p class="man-name">
  <code>bagatela</code> - <span class="man-whatis">wyszukiwarka, bagatela, połączeń w komunikacji miejskiej</span>
</p>

<h2 id="WST-P-DO-API">WSTĘP DO API</h2>

<p>API (Interfejs Programowania Aplikacji) umożliwia programowy dostęp do danych (<a href="#PRZYSTANEK" data-bare-link="true">przystanków</a>, <a href="#ROZK-AD-JAZDY" data-bare-link="true">rozkładów jazdy</a>) i usług (<a href="#WYSZUKIWARKA-PO-CZE-" data-bare-link="true">wyszukiwarka połączeń</a>) z poziomu aplikacji trzecich.</p>

<p>API jest zgodne ze wzorcem <a href="http://en.wikipedia.org/wiki/Representational_State_Transfer">REST</a>. Interakcja na zbiorach odbywa się protokołem HTTP i pozwala na wykonywanie zapytań typu GET, POST, PUT i DELETE. Dane przyjmowane i zwracane są w formacie <a href="http://json.org">JSON</a>.</p>

<h3 id="Url">Url</h3>

<p>Każde miasto posiada swój własny adres url według wzoru:</p>

<pre><code>http://api.bagate.la/&lt;kod_miasta>
</code></pre>

<p>Oto kody miast, których rozkłady są aktualnie gromadzone (oczekuj nowych miast):</p>

<pre><code>sk - Górnośląski Okręg Przemysłowy (od 20.06.2011)
kr - Kraków (od 20.06.2011)
dw - Wrocław (od 20.06.2011)
</code></pre>

<h3 id="Przyk-ady">Przykłady</h3>

<p>Wszystkie przykłady interakcji z API korzystają z prostego narzędzia konsoli <code>curl</code> i zostały wykonane w systemie GNU/Linux.</p>

<pre><code>curl http://api.bagate.la --verbose
</code></pre>

<pre><code>* About to connect() to api.bagate.la port 80 (#0)
*   Trying 31.222.178.135... connected
* Connected to api.bagate.la (31.222.178.135) port 80 (#0)
> GET / HTTP/1.1
> User-Agent: curl/7.21.3 (x86_64-pc-linux-gnu) libcurl/7.21.3 OpenSSL/0.9.8o zlib/1.2.3.4 libidn/1.18
> Host: api.bagate.la
> Accept: */*
> 
< HTTP/1.1 200 OK
< Content-Type: application/json
< Connection: keep-alive
< Status: 200
< X-Powered-By: Phusion Passenger (mod_rails/mod_rack) 3.0.7
< Content-Length: 48
< Server: nginx/1.0.4 + Phusion Passenger 3.0.7 (mod_rails/mod_rack)
< 
* Connection #0 to host api.bagate.la left intact
* Closing connection #0
{"message":"Welcome aboard!","version":"40f6ca"}</code></pre>


<h3 id="Debugging">Debugging</h3>

<p>Flaga <code>--verbose</code> wyświetla bardziej szczegółowe informacje o połączeniu. Więcej informacji o narzędziu <code>curl</code> znajdziesz w <a href="http://curl.haxx.se/docs/manpage.html">jego dokumentacji</a>. Przy nauce protokołu, przydatne mogą okazać się również <a href="http://justniffer.sourceforge.net/index.html">inne</a> <a href="http://postbin.org">narzędzia</a>.</p>

<h3 id="Kontrybucja">Kontrybucja</h3>

<p>(również do dokumentacji) jest mile widziana! Weź <a href="https://github.com/Stanley/bagatela" data-bare-link="true">https://github.com/Stanley/bagatela</a> na widły i poproś o akceptacje zmian.</p>

<h2 id="ZAPYTANIA-O-DANE">ZAPYTANIA O DANE</h2>

<p>Ponieważ dane są przechowywane w bazie danych CouchDB, która udostępnia interfejs REST, nasz interfejs programistyczny jest z nim całkowicie zgodny. Jego szczegóły opisano w <a href="http://wiki.apache.org/couchdb/">dokumentacji CouchDB API</a>.</p>

<h3 id="Dokumenty">Dokumenty</h3>

<p>Dokument jest podstawową strukturą organizacji danych w bazie. Motywacją użycia takiej jednostki jest łatwość przenoszenia rzeczywistych obiektów (takich jak rozkłady jazdy) do postaci zrozumiałej dla komputera. Dokumenty są ograniczone, nie sztywną strukturą, a jedynie tym, że składają się z tablicy dowolnej ilości par, w których kluczem jest napis, a wartością dana o jedym z typów: binarny, napis, liczba, tablica, tablica asocjacyjna lub niezdefiniowany. W bazie danych dokumenty są przechowywane w formacie JSON i w tej samej formie są zwracane na zewnątrz.</p>

<p>Każdy dokument posiada unikalny identyfikator <code>_id</code> oraz numer rewizji <code>_rev</code>. Atrybuty te są nadawane automatycznie przez bazę danych. Aby otrzymać pojedynczy dokument, (prawie zawsze) wystarczy przekazać jedynie identyfikator <code>_id</code>. Np.:</p>

<pre><code>http://api.bagate.la/kr/d778919c8c13d6dfc59d8a4fbcffa409
</code></pre>

<p>Ścieżka: <code>/&lt;id></code><br />
Metoda: <code>GET</code><br />
Parametry: <code>id</code>, <code>rev</code> (opcjonalnie) - numer rewizji<br />
Odpowiedź: dokument o identyfikatorze <code>id</code> (domyślnie najnowsza rewizja).</p>

<p>Przykładowe użycie:</p>

<pre><code>curl -XGET http://api.bagate.la/kr/d778919c8c13d6dfc59d8a4fbcffa409
</code></pre>

<pre class="highlight"><code class="language-javascript">{
  "_id":"d778919c8c13d6dfc59d8a4fbcffa409",
  "_rev":"3-c7ea32524b4fb94e66d7214a2eb62427",
  "type":"Stop",
  "updated_at":"2011-06-24T08:47:04Z",
  "name":"Agatowa",
  "location":{
    "lat":50.02198398,
    "lon":20.04249077
  }
}</code></pre>


<p>Przeczytaj więcej o dokumentach w CouchDB na: <a href="http://guide.couchdb.org/editions/1/en/api.html#documents" data-bare-link="true">http://guide.couchdb.org/editions/1/en/api.html#documents</a>.</p>

<h3 id="Widoki">Widoki</h3>

<p>Widok to predefiniowany indeks danych. Definicja widoku jest w bazie danych specjalnym dokumentem i zawiera funkcje: mapującą i opcjonalnie redukującą. Funkcje przetwarzają każdy dokument z osobna i zapisują wynik w posortowanej liście (widoku). Istnieją dwa rodzaje wyszukań tego indeksu: o dokumenty z danym kluczem i o dokumenty z kluczami mieszczącymi się w danym zakresie. Jeżeli znamy konkretny klucz i dodamy go ścieżki widoku w parametrze <code>key</code>, to w rezultacie otrzymamy wartość wygenerowaną przez dokument (jeden lub więcej, gdy klucz nie jest unikalny), będący wynikiem przetwarzania funkcją mapującą lub redukującą.</p>

<p>Częstszym użyciem widoków jest pytanie o zbiór dokumentów, których klucze są zawarte w pewnym przedziale. Aby ułatwić takie zapytania, klucze często są wartością typu lista, np. <em>[2010, 10, 6]</em>. Dzięki temu jesteśmy w stanie zapytać o wszystkie dokumenty, których klucz zawiera się w danym przedziale np. od <em>[2010, 9]</em> do <em>[2010, 10, {}]</em> (w tym przypadku, gdzie kluczem jest data, zapytanie zwróci wszystkie dokumenty z kluczem od 1 września do 30 października).</p>

<p>Przeczytaj więcej o widokach w CouchDB na: <a href="http://guide.couchdb.org/editions/1/en/views.html" data-bare-link="true">http://guide.couchdb.org/editions/1/en/views.html</a>.</p>

<p>Ścieżka: <code>/_design/&lt;zasób>/_view/&lt;widok></code><br />
Metoda: <code>GET</code><br />
Parametry:</p>

<ul>
<li><code>descending</code> - jeżeli <em>true</em>, odwrócona kolejność zwracanych dokumentów. Uwaga: sortowanie odbywa się przed ograniczeniem przedziału. Może to oznaczać konieczność zamiany parametrów <code>startkey</code> z <code>endkey</code>.</li>
<li><code>endkey</code> - koniec przedziału włącznie. Domyślnie największa możliwa wartość.</li>
<li><code>endkey_docid</code> - identyfikator ostatniego dokumentu w odpowiedzi (używane do paginacji).</li>
<li><code>group</code> - jeżeli <em>false</em> to redukuje wszystkie dokumenty zgodnie z funkcją redukującą do jednej wartości. W przeciwnym wypadku wyniki przetwarzania każdego z dokumentów są grupowane. Domyślnie <em>false</em>.</li>
<li><code>group_level</code> - grupuje wyniki przetwarzania funkcją redukującą, mające pierwszych <em>grup_level</em> takich samych wartości klucza. Np.: klucze <em>["a", "b", "c"], ["a", "b", "d"], ["a", "c", "d"]</em> z parametrem <em>group_level=2</em> utworzą dwie grupy <em>["a", "b"], ["a", "c"]</em> . Jeżeli parametr <code>group</code> będzie <em>true</em> a <code>group_level</code> niezdefiniowany, to zwrócony zostanie wynik przetwarzania każdego dokumentu z osobna.</li>
<li><code>include_docs</code> - jeżeli <em>true</em>, dołącza oryginalny dokument w polu <code>doc</code>. Domyślnie <em>false</em>.</li>
<li><code>inclusive_end</code> - definiuje czy dokument o kluczu <code>endkey</code> jest dołączany do odpowiedzi. Domyślnie <em>true</em>.</li>
<li><code>key</code> - dokładna wartość klucza.</li>
<li><code>limit</code> - maksymalna liczba zwróconych dokumentów. Np. <em>10</em>.</li>
<li><code>reduce</code> - użyj funkcji redukującej. Domyślna wartość, gdy funkcja redukująca jest zdefiniowana, to <em>true</em>.</li>
<li><code>skip</code> - liczba pomijanych dokumentów. Domyślnie <em>0</em>.</li>
<li><code>stale</code> - definiuje czy akceptować przedawniony widok, w celu otrzymania natychmiastowej odpowiedzi (w przypadku gdy nowy widok jeszcze nie skończył się generować). Możliwa wartość: <em>ok</em>.</li>
<li><code>startkey</code> - początek przedziału włącznie. Domyślnie najmniejsza możliwa wartość.</li>
<li><code>startkey_docid</code> - identyfikator pierwszego dokumentu w odpowiedzi (używane do paginacji).</li>
</ul>


<p>Wszystkie wyżej wymienione parametry są opcjonalne.</p>

<h2 id="ZASOBY">ZASOBY</h2>

<p>Zasób jest podzbiorem danych w bazie, wydzielonych względem typu (klasy) danej, którą reprezentuje. Typ zasobu do którego należy dokument jest określony w polu <code>type</code>.</p>

<h2 id="ROZK-AD-JAZDY">ROZKŁAD JAZDY</h2>

<p>Fizycznie reprezentuje wydruk z przystanku. Jest związany z jedną linią i z jednym przystankiem. Obowiązuje w ograniczonej ramie czasowej (choć data upływu ważności nie jest znana dopóki nie zostanie opublikowana aktualizacja rozkładu). Jest wiernym odzwierciedleniem tego co jest publikowane przez przewoźników na ich oficjalnych stronach i nie zawiera żadnych dodatkowych inforamcji (oprócz opcjonalnych atrybutów <code>stop_id</code> i <code>valid_until</code>).</p>

<h3 id="Atrybuty">Atrybuty</h3>

<ul>
<li><code>_id</code> - identyfikator.</li>
<li><code>_rev</code> - numer rewizji.</li>
<li><code>line</code> - numer linii, którą opisuje rozkład. Np. <em>"4"</em>.</li>
<li><code>route</code> - trasa linii. Lista głównych ulic, którymi biegnie linia. Np. <em>"Al. 3 Maja, Podwale, Basztowa, Lubicz, Rakowicka"</em>.</li>
<li><code>destination</code> (tylko jeżeli parametr <code>route</code> nie istnieje) - przystanek docelowy. Np. <em>"Okęcie"</em>.</li>
<li><code>stop</code> - nazwa przystanku na którym znajduje się rozkład. Np. <em>"Batorego"</em>.</li>
<li><code>stop_id</code> (opcjonalnie) - identyfikator przystanku <code>Stop</code> przy którym zatrzymuje się transport.</li>
<li><code>table</code> - tablice odjazdów. Atrybut typu tablicy asocjacyjnej, przechowującej pary, w których opisowi dni odpowiada tablica odjazdów. Opis dania (klucz) to np. <em>"Dzień powszedni"</em>. Tablica odjazdów (wartość) to np. <em>{"4":["43"], "5":["02","17","38","48","58"]}</em>, co oznacza, że w dni powszednie, o godzinie 4:43, 5:02, 5:17 itd. odjeżdża transport. Minuty są ciągiem znaków, gdyż mogą zawierać opis kursu. Np. <em>"24A"</em>.</li>
<li><code>type</code> - typ. Zawsze <em>"Timetable"</em>.</li>
<li><code>source</code> - źródło danych. Np. adres URL: <em>"http://rozklady.mpk.krakow.pl/aktualne/0004/0004t023.htm"</em>.</li>
<li><code>updated_at</code> - czas ostatniej modyfikacji w bazie danych (tj. czas połączenia ze źródłem).</li>
<li><code>valid_from</code> - dzień od którego obowiązuje rozkład. Np. <em>"04.10.2010"</em>.</li>
<li><code>valid_until</code> (opcjonalnie) - dzień do którego obowiązuje rozkład. Jeżeli atrybut nie jest zdefiniowany i <code>valid_from</code> wskazuje na przeszły dzień to rozkład jazdy jest aktualnie obowiązującym. Atrybut zostanie zdefiniowany nie wcześniej, niż nowa wersja tego rozkładu zostanie publikowana lub aktualny zostanie anulowany.</li>
</ul>


<h3 id="Za-czniki">Załączniki</h3>

<ul>
<li><code>source.html</code> - oryginalna strona HTML z rozkładem jazdy.</li>
</ul>


<h3 id="Widoki">Widoki</h3>

<p>Definicje funkcji mapujących, redukujących i listujących rozkłady jazdy, są dokumentem o idenyfikatorze <em>"_design/Timetables"</em>.</p>

<p><strong>[map] by_line</strong></p>

<p>Ścieżka: <code>/_design/Timetables/_view/by_line?reduce=false</code><br />
Metoda: <code>GET</code><br />
Odpowiedź: lista rozkładów jazdy<br />
Kolejność sortowania: <code>line</code>, <code>destination</code>, <code>source</code></p>

<p>Przykładowe użycie:</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_design/Timetables/_view/by_line?startkey=["6","SALWATOR"]&amp;endkey=["6","SALWATOR",{}]&amp;reduce=false
</code></pre>

<p>Zwraca listę rozkładów na linii numer <em>"6"</em>, jadącej w kierunku przystanku <em>"Salwator"</em>, posortowanych od pierwszego do ostatniego.</p>

<p><strong>[reduce] by_line</strong></p>

<p>Jeżeli interesuje nas opis danej lini (będący skrótem informacji z wielu rozkładów jazdy), musimy skorzystać z widoku wygenerowanego funkcją redukującą.</p>

<p>Ścieżka: <code>/_design/Timetables/_view/by_line</code><br />
Metoda: <code>GET</code><br />
Odpowiedź: liczba dokumentów w danej grupie</p>

<p>Przykładowe użycia:</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_design/Timetables/_view/by_line?startkey=["113","ALEJA PRZYJAŹNI"]&amp;endkey=["113","ALEJA PRZYJAŹNI",{}]&amp;group_level=2
</code></pre>

<p>Zwraca liczbę przystanków na linii <em>113</em> w kierunku przystanku <em>Aleja Przyjaźni</em>.</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_design/Timetables/_view/by_line?group_level=1
</code></pre>

<p>Zwraca liczbę przystanków na wszystkich liniach o tym samym numerze (tam i z powrotem). Zapytanie jest również przydatne, gdy chcemy uzyskać listę numerów linii (które w zwróconym rezultacie są kluczem; parametr <code>key</code>). Należy pamiętać, że numery linii są ciągami znaków, a nie liczb, dlatego linia <em>"10"</em> pojawi się przed <em>"2"</em>.</p>

<p><strong>[map] by_source</strong></p>

<p>Ścieżka: <code>/_design/Timetables/_view/by_source</code><br />
Metoda: <code>GET</code><br />
Odpowiedź: lista rozkładów jazdy<br />
Kolejność sortowania: <code>source</code>, <code>valid_from</code></p>

<p>Przykładowe użycie.</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_design/Timetables/_view/by_source?startkey=["http://rozklady.mpk.krakow.pl/aktualne/0000/0000t001.htm"]&amp;limit=1
</code></pre>

<p>Zwraca najnowszy rozkład jazdy pozyskany z danego źródła.</p>

<p><strong>[map] by_stop</strong></p>

<p>Ścieżka: <code>/_design/Timetables/_view/by_stop</code><br />
Metoda: <code>GET</code><br />
Odpowiedź: lista przystanków i rozkładów jazdy<br />
Kolejność sortowania: <code>stop</code>, <code>line</code>, <code>destination</code></p>

<p>Przykładowe użycie:</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_design/Timetables/_view/by_stop?key=["Agatowa","125","ZŁOCIEŃ"]
</code></pre>

<p>Zwraca rozkłady jazdy linii <em>"125"</em>, w stronę przystanku <em>"Złocień"</em>, na przystanku <em>"Agatowa"</em>.</p>

<p><strong>[map] by_stop_id</strong></p>

<p><strong>UWAGA</strong>: <em>ten widok wymaga, aby rozkłady jazdy deklarowały konkretny przystanek na którym się znajdują w polu <code>stop_id</code>, które może być nie zdefiniowane.</em></p>

<p>Ścieżka: <code>/_design/Timetables/_view/by_stop_id</code><br />
Metoda: <code>GET</code><br />
Odpowiedź: lista przystanków i rozkładów jazdy<br />
Kolejność sortowania przystanków: <code>id</code><br />
Kolejność sortowania rozkładów: <code>line</code></p>

<p>Przykładowe użycie:</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_design/Timetables/_view/by_stop_id?startkey=["d778919c8c13d6dfc59d8a4fbcfeeb5f"]&amp;endkey=["d778919c8c13d6dfc59d8a4fbcfeeb5f",{}]
</code></pre>

<p>Zwraca przystanek oraz wszystkie rozkłady jazdy na danym przystanku. Aby pominąć przystanek, należy dodać parametr <code>skip=1</code>.</p>

<p><strong>[list] filter</strong></p>

<p>Ścieżka: <code>/_design/Timetables/_list/filter/&lt;widok></code><br />
Metoda: <code>GET</code><br />
Parametr: <code>widok</code>, <code>only</code> lub <code>except</code> - lista parametrów, połączonych przecinkiem, które mają (lub których nie mają) zawierać wartości zwrócone przez funckję mapującą<br />
Odpowiedź: to samo co zwróci widok, z filtrowanymi wartościami</p>

<p>Przykładowe użycie:</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_design/Timetables/_list/filter/by_line?only=stop,table&amp;reduce=false&amp;limit=1
</code></pre>

<p>Zwraca jeden rozkład jazdy z polami: <code>stop</code> i <code>table</code>.</p>

<p><a href="https://github.com/Stanley/bagatela/blob/master/features/timetables_design.feature">Zobacz scenariusze testujące <em>"_design/Timetables"</em>.</a></p>

<h2 id="PRZYSTANEK">PRZYSTANEK</h2>

<p>Fizyczna wiata lub słup przy którym wiszą rozkłady jazdy i zatrzymują się pojazdy komunikacji.</p>

<h3 id="Atrybuty">Atrybuty</h3>

<ul>
<li><code>_id</code> - identyfikator.</li>
<li><code>_rev</code> - numer rewizji.</li>
<li><code>address</code> (opcjonalnie) - ulica przy której znajduje się przystanej. Np. "Karmelicka".</li>
<li><code>location.lat</code> - szerokość geograficzna. Np. <em>50.06309891</em>.</li>
<li><code>location.lon</code> - długość geograficzna. Np. <em>19.9326992</em>.</li>
<li><code>name</code> - nazwa przystanku. Np. <em>"Teatr Bagatela"</em>.</li>
<li><code>operates</code> (opcjonalnie) - lista typów pojazdów, które obsługuje przystanek. Np. <em>["Trams", "Buses"]</em>.</li>
<li><code>polylines</code> (opcjonalnie) - tablica asocjacyjna, gdzie kluczem jest identyfikator dowolnego przystanku, a wartością tablica współrzędnych, tworzących linię łamaną, połączenie tych dwóch przystanków.</li>
<li><code>type</code> - typ. Zawsze <em>"Stop"</em>.</li>
<li><code>updated_at</code> - czas ostatniej modyfikacji.</li>
</ul>


<p>Definicje funkcji mapujących, redukujących i listujących przystanki są dokumentem o idenyfikatorze <em>"_design/Stops"</em>.</p>

<h3 id="Widoki">Widoki</h3>

<p><strong>[map] by_line</strong></p>

<p><strong>UWAGA</strong>: <em>ten widok wymaga, aby rozkłady jazdy deklarowały konkretny przystanek na którym się znajdują w polu <code>stop_id</code>, które może być nie zdefiniowane.</em></p>

<p>Ścieżka: <code>/_design/Stops/_view/by_line</code><br />
Metoda: <code>GET</code><br />
Odpowiedź: lista przystanków
Kolejność sortowania: <code>line</code>, <code>destination</code>, <code>source</code></p>

<p>Przykładowe użycie:</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_design/Stops/_view/by_line?startkey=["9","MISTRZEJOWICE"]&amp;endkey=["9","MISTRZEJOWICE",{}]
</code></pre>

<p>Zwraca wszystkie przystanki na linii <em>"9"</em>, jadącej w kierunku przystanku <em>"Mistrzejowice"</em>.</p>

<p><strong>[map] by_name</strong></p>

<p>Ścieżka: <code>/_design/Stops/_view/by_name</code><br />
Metoda: <code>GET</code><br />
Odpowiedź: lista przystanków<br />
Kolejność sortowania: <code>name</code>, <code>address</code></p>

<p>Przykładowe użycie:</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_design/Stops/_view/by_name?key=["Reymana","Aleja 3 maja"]
</code></pre>

<p>Zwraca przystanki o nazwie <em>"Reymana"</em> i adresie <em>"Aleja 3 maja"</em>. Uwaga: możemy otrzymać więcej niż jeden dokument, mimo że nie zdefiniowaliśmy zakresu klucza, a konkretną wartość, która w tym przypadku nie jest unikalna.</p>

<!-- TODO: reduce by_name -->


<p><strong>[list] filter</strong></p>

<p>Ścieżka: <code>/_design/Stops/_list/filter/&lt;widok></code><br />
Metoda: <code>GET</code><br />
Parametr: <code>widok</code>, <code>only</code> lub <code>except</code> - lista parametrów, połączonych przecinkiem, które mają (lub których nie mają) zawierać wartości zwrócone przez funckję mapującą<br />
Odpowiedź: to samo co zwróci widok, z filtrowanymi wartościami</p>

<p>Przykładowe użycie:</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_design/Stops/_list/filter/by_name?except=polylines,type,updated_at&amp;limit=1
</code></pre>

<p>Zwraca jeden przystanek bez pól: <code>polylines</code>, <code>type</code> i <code>updated_at</code>.</p>

<!--
**[list] polyline**

Ścieżka: `/_design/Stops/_list/polyline/<var>widok</var>`
Metoda: `GET`  
Parametr: `widok`
-->


<p><a href="https://github.com/Stanley/bagatela/blob/master/features/stops_design.feature">Zobacz scenariusze testujące <em>"_design/Stops"</em>.</a></p>

<h3 id="Wyszukiwarka">Wyszukiwarka</h3>

<p>Usługa, która pozwala na wyszukiwanie przystanków po nazwie lub lokalizacji. Ponieważ silnikiem wyszukiwarki jest elasticsearch, pełna dokumentacja API znajduje się na stronie: <a href="http://www.elasticsearch.org/guide/reference/api/search/" data-bare-link="true">http://www.elasticsearch.org/guide/reference/api/search/</a>.</p>

<p>Ścieżka: <code>/_search/Stops?q=&lt;fraza></code><br />
Metoda: <code>GET</code><br />
Paramerty:</p>

<ul>
<li><code>q</code> - fraza. Akceptuje mi. wieloznaczniki <em>*</em> i <em>?</em> oraz wyrażenia logiczne <em>OR</em> i <em>AND</em>.</li>
<li><code>sort</code> (opcjonalnie) - sortowanie, np.: <em>"name:asc"</em> (po nazwie, rosnąco). Domyślnie po trafności.</li>
<li><code>size</code> (opcjonalnie) - maksymalna liczba dokumentów spełniających kryteria zapytania.</li>
<li>W zapytaniu możliwe są również inne opcje, wszystkie zostały opisane na: <a href="http://www.elasticsearch.org/guide/reference/api/search/uri-request.html" data-bare-link="true">http://www.elasticsearch.org/guide/reference/api/search/uri-request.html</a>.</li>
</ul>


<p>Odpowiedź: lista przystanków spełniających kryteria tj. zawierają <em>frazę</em> w nazwie lub lokalizacji.</p>

<p>Frazę można doprecyzować, dopisując przed nią <em>name:</em> lub <em>address:</em>, co ograniczy wyszukiwanie do określonego pola.</p>

<p>Przykładowe użycia:</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_search/Stops?q=baszt*
</code></pre>

<p>Zwróci wszystkie przystanki, których nazwa lub lokalizacja zawiera słowo zaczynające się od: <em>"baszt"</em>.</p>

<pre><code>curl -XGET http://api.bagate.la/kr/_search/Stops?q=dworzec%20AND%20location:basztowa
</code></pre>

<p>Zwróci wszystkie przystanki, których nazwa lub lokalizacja zawiera słowo <em>"dworzec"</em>, a lokalizacja zawiera słowo <em>"basztowa"</em>.</p>

<p><strong>Alternatywne użycie:</strong></p>

<p>Ścieżka: <code>/_search/Stops</code><br />
Metoda: <code>POST</code><br />
Ładunek: Zapytanie DSL w formacie JSON</p>

<p>DSL (język zapytania) jest udokumentowany na stronie: <a href="http://www.elasticsearch.org/guide/reference/query-dsl/" data-bare-link="true">http://www.elasticsearch.org/guide/reference/query-dsl/</a>. Ta forma pozwala formułować bardziej skomplikowane zapytania, ale wymaga znajomości języka.</p>

<p>Przykładowe użycie:</p>

<pre><code>curl -XPOST http://api.bagate.la/kr/_search/Stops -d '{
  "query": {
    "filtered" : {
      "query" : {
        "match_all" : {}
      },
      "filter" : {
        "geo_distance" : {
          "distance" : "1km",
          "location" : {
            "lat" : 50.06551,
            "lon" : 19.94693
          }
        }
      }
    }
  }
}'
</code></pre>

<p>Zwróci wszystkie przystanki w promieniu <em>1</em> kilometra od Dworca Głównego w Krakowie (punkt: <em>50.06551, 19.94693</em>).</p>

<p><a href="https://github.com/Stanley/bagatela/blob/master/features/stops_search.feature">Zobacz scenariusze testujące.</a></p>

<h2 id="WYSZUKIWARKA-PO-CZE-">WYSZUKIWARKA POŁĄCZEŃ</h2>

<p>Comming soon.</p>

<h2 id="REPLIKACJE">REPLIKACJE</h2>

<p>Replikacje są wykorzystywane do synchronizacji dwóch kopii tej samej bazy danych.</p>

<p>Ścieżka: <code>http://api.bagate.la/_replicate</code><br />
Metoda: <code>POST</code><br />
Parametry ładunku:</p>

<ul>
<li><code>source</code> - <em>kod_miasta</em> czyli identyfikator bazy danych będącej źródłem danych np.: <em>"kr"</em>.</li>
<li><code>target</code> - baza danych do której eksportujemy dane np.: <em>"http://user:password@rozklady.cloudant.com/kr"</em>.</li>
<li><code>continuous</code> (opcjonalnie) - jeżeli <em>true</em> replikacja będzie trwała do momentu w którym sami przerwiemy proces (wysyłając podobne zapytanie z parametrem "<code>cancel</code>"<em>:true</em>)</li>
</ul>


<p>Odpowiedź: Raport z wykonanej (lub przerwanej) replikacji.</p>

<p>Przykładowe użycie:</p>

<pre><code>curl -XPOST http://api.bagate.la/_replicate -H 'Content-Type: application/json' -d '{
  "source":"dw",
  "target":"https://stanley:&lt;password>@stanley.cloudant.com/dw/"
}'    
</code></pre>

<h2 id="SCENARIUSZE-TESTUJ-CE">SCENARIUSZE TESTUJĄCE</h2>

<p>Aby zapewnić stabilność i niezawodność API, konieczne jest posiadanie testów funkcjonalnych. Ponieważ są one również świetną dokumentacją, dla każdego zagadnienia dokumentacji <a href="https://github.com/Stanley/bagatela/tree/master/features">został napisany</a> odrępny test. Każdy z nich jest scenariuszem użycia API w czystym i zrozumiałym dla każdego języku angielskim, który jest interpretowany przez komputer za pomocą nadzędzia <a href="http://cukes.info/">Cucumber</a>.</p>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24458797-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>





  <ol class='man-decor man-foot man foot'>
    <li class='tl'>Stanisław Wasiutyński</li>
    <li class='tc'>July 2011</li>
    <li class='tr'>bagatela(1)</li>
  </ol>

  </div>
</body>
</html>
